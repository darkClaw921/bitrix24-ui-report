<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i data-lucide="bot" class="logo-icon"></i>
                    <span>чат с битрикс24</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/" class="nav-item active">
                    <i data-lucide="message-circle"></i>
                    <span>Чат</span>
                </a>
                <a href="/conversations" class="nav-item">
                    <i data-lucide="folder"></i>
                    <span>Диалоги</span>
                </a>
                <a href="/settings" class="nav-item">
                    <i data-lucide="settings"></i>
                    <span>Настройки</span>
                </a>
            </nav>
            
            <div class="conversation-list">
                <div class="conversation-header">
                    <h3>Недавние диалоги</h3>
                    <button id="new-conversation-btn" class="btn-icon" title="Новый диалог">
                        <i data-lucide="plus"></i>
                    </button>
                </div>
                <div id="conversations-container" class="conversations">
                    <!-- Conversations will be loaded here -->
                </div>
            </div>
        </aside>
        
        <!-- Main Chat Area -->
        <main class="chat-container">
            <div class="chat-header">
                <div class="chat-title">
                    <h2 id="conversation-title">Новый диалог</h2>
                    <div class="provider-status" id="provider-status">
                        <span class="provider-dot"></span>
                        <span id="current-provider">OpenAI</span>
                    </div>
                </div>
                
                <div class="chat-controls">
                    <select id="provider-select" class="provider-select">
                        {% for provider in available_providers %}
                        <option value="{{ provider }}">{{ provider.title() }}</option>
                        {% endfor %}
                    </select>
                    
                    <select id="model-select" class="model-select">
                        <option value="">Модель по умолчанию</option>
                    </select>
                    
                    <button id="clear-chat-btn" class="btn-secondary" title="Очистить чат">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messages-container">
                <div class="welcome-message">
                    <div class="welcome-icon">
                        <i data-lucide="bot"></i>
                    </div>
                    <h3>Добро пожаловать в AI Chat!</h3>
                    <p>Начните диалог с искусственным интеллектом. Вы можете задавать вопросы, просить создать графики и диаграммы, или просто общаться.</p>
                    <div class="welcome-features">
                        <div class="feature">
                            <i data-lucide="bar-chart-3"></i>
                            <span>Автоматическое создание графиков</span>
                        </div>
                        <div class="feature">
                            <i data-lucide="globe"></i>
                            <span>Поддержка разных LLM провайдеров</span>
                        </div>
                        <div class="feature">
                            <i data-lucide="save"></i>
                            <span>Сохранение диалогов</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="message-input" 
                        class="message-input" 
                        placeholder="Напишите сообщение... (Ctrl+Enter для отправки)"
                        rows="1"
                    ></textarea>
                    <button id="send-btn" class="send-btn" disabled>
                        <i data-lucide="send"></i>
                    </button>
                </div>
                
                <div class="input-footer">
                    <div class="input-info">
                        <span class="connection-status" id="connection-status">
                            <span class="status-dot connecting"></span>
                            Подключение...
                        </span>
                    </div>
                    
                    <div class="input-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="stream-mode" checked>
                            <span class="checkbox-custom"></span>
                            Потоковый режим
                        </label>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Генерация ответа...</p>
        </div>
    </div>
    
    <!-- Chart modal -->
    <div id="chart-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>График</h3>
                <button class="modal-close" onclick="closeChartModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <canvas id="chart-canvas"></canvas>
            </div>
        </div>
    </div>
    
    <script src="/static/js/websocket.js"></script>
    <script src="/static/js/charts.js"></script>
    <script src="/static/js/chat.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Simple conversation loader
        async function loadRecentConversations() {
            try {
                const response = await fetch('/api/conversations');
                const conversations = await response.json();
                
                const container = document.getElementById('conversations-container');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (conversations.length === 0) {
                    container.innerHTML = '<div class="no-conversations"><p>Нет сохраненных диалогов</p></div>';
                    return;
                }
                
                conversations.forEach(conversation => {
                    const conversationElement = document.createElement('div');
                    conversationElement.className = 'conversation-item';
                    conversationElement.innerHTML = `
                        <div class="conversation-title">${conversation.title}</div>
                        <div class="conversation-meta">
                            <span>${conversation.message_count} сообщений</span>
                            <span>${new Date(conversation.updated_at).toLocaleDateString('ru-RU')}</span>
                        </div>
                    `;
                    
                    conversationElement.addEventListener('click', async () => {
                        try {
                            // Update URL
                            window.history.pushState({}, '', `/?conversation=${conversation.id}`);
                            
                            // Update conversation title
                            const titleElement = document.getElementById('conversation-title');
                            if (titleElement) {
                                titleElement.textContent = conversation.title;
                            }
                            
                            // Load conversation messages
                            await loadConversationMessages(conversation.id);
                            
                            // Update active conversation
                            document.querySelectorAll('.conversation-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            conversationElement.classList.add('active');
                            
                        } catch (error) {
                            console.error('Error loading conversation:', error);
                            alert('Ошибка загрузки диалога: ' + error.message);
                        }
                    });
                    
                    container.appendChild(conversationElement);
                });
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }
        
        // Load conversation messages
        async function loadConversationMessages(conversationId) {
            try {
                const response = await fetch(`/api/chat/conversations/${conversationId}/messages`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const messages = await response.json();
                const messagesContainer = document.getElementById('messages-container');
                
                if (messagesContainer) {
                    messagesContainer.innerHTML = '';
                    
                    if (messages.length === 0) {
                        messagesContainer.innerHTML = `
                            <div class="welcome-message">
                                <div class="welcome-icon">
                                    <i data-lucide="bot"></i>
                                </div>
                                <h3>Диалог пуст</h3>
                                <p>Начните общение, написав первое сообщение.</p>
                            </div>
                        `;
                        lucide.createIcons();
                        return;
                    }
                    
                    messages.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${msg.role}`;
                        
                        const avatar = msg.role === 'user' ? 'У' : 'AI';
                        messageElement.innerHTML = `
                            <div class="message-avatar">${avatar}</div>
                            <div class="message-content">
                                <div class="message-bubble">
                                    <div class="message-text">${msg.content}</div>
                                </div>
                                <div class="message-meta">
                                    <span>${new Date(msg.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</span>
                                    ${msg.provider ? `<span>${msg.provider}</span>` : ''}
                                </div>
                            </div>
                        `;
                        
                        messagesContainer.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                throw error;
            }
        }
        
        // Check URL for conversation ID on page load
        async function checkUrlForConversation() {
            const urlParams = new URLSearchParams(window.location.search);
            const conversationId = urlParams.get('conversation');
            
            if (conversationId) {
                try {
                    // Find conversation info
                    const response = await fetch('/api/conversations');
                    const conversations = await response.json();
                    const conversation = conversations.find(c => c.id === conversationId);
                    
                    if (conversation) {
                        // Update title
                        const titleElement = document.getElementById('conversation-title');
                        if (titleElement) {
                            titleElement.textContent = conversation.title;
                        }
                        
                        // Load messages
                        await loadConversationMessages(conversationId);
                        
                        // Mark as active after conversations are loaded
                        setTimeout(() => {
                            const conversationElements = document.querySelectorAll('.conversation-item');
                            conversationElements.forEach(item => {
                                if (item.innerHTML.includes(conversation.title)) {
                                    item.classList.add('active');
                                }
                            });
                        }, 100);
                    }
                } catch (error) {
                    console.error('Error loading conversation from URL:', error);
                }
            }
        }
        
        // Enhanced message sending function
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (!messageInput || !sendBtn) return;
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            const urlParams = new URLSearchParams(window.location.search);
            const conversationId = urlParams.get('conversation');
            
            try {
                sendBtn.disabled = true;
                messageInput.value = '';
                
                // Hide welcome message if shown
                const welcomeMessage = document.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
                
                // Add user message to UI immediately
                const messagesContainer = document.getElementById('messages-container');
                if (messagesContainer) {
                    const userMessageElement = document.createElement('div');
                    userMessageElement.className = 'message user';
                    userMessageElement.innerHTML = `
                        <div class="message-avatar">У</div>
                        <div class="message-content">
                            <div class="message-bubble">
                                <div class="message-text">${message}</div>
                            </div>
                            <div class="message-meta">
                                <span>${new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                        </div>
                    `;
                    messagesContainer.appendChild(userMessageElement);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
                
                // Send message to API
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: conversationId,
                        provider: 'openai',
                        model: null,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Add assistant message to UI
                    if (messagesContainer) {
                        const assistantMessageElement = document.createElement('div');
                        assistantMessageElement.className = 'message assistant';
                        assistantMessageElement.innerHTML = `
                            <div class="message-avatar">AI</div>
                            <div class="message-content">
                                <div class="message-bubble">
                                    <div class="message-text">${data.message.content}</div>
                                </div>
                                <div class="message-meta">
                                    <span>${new Date(data.message.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</span>
                                    <span>${data.message.provider || 'openai'}</span>
                                </div>
                            </div>
                        `;
                        messagesContainer.appendChild(assistantMessageElement);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                    
                    // Update URL if new conversation
                    if (data.conversation_id !== conversationId) {
                        window.history.pushState({}, '', `/?conversation=${data.conversation_id}`);
                        // Reload conversations list
                        await loadRecentConversations();
                    }
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Ошибка отправки сообщения: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                updateSendButton();
            }
        }
        
        // Update send button state
        function updateSendButton() {
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (messageInput && sendBtn) {
                sendBtn.disabled = messageInput.value.trim().length === 0;
            }
        }
        
        // Initialize event listeners
        function initializeEventListeners() {
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const newConversationBtn = document.getElementById('new-conversation-btn');
            
            if (messageInput) {
                messageInput.addEventListener('input', updateSendButton);
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (newConversationBtn) {
                newConversationBtn.addEventListener('click', () => {
                    window.location.href = '/';
                });
            }
        }
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadRecentConversations();
                await checkUrlForConversation();
                initializeEventListeners();
            } catch (error) {
                console.error('Error initializing page:', error);
            }
        });
    </script>
</body>
</html>